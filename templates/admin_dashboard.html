<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SentinelWeb - Dashboard Executivo</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }
        
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .kpi-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 15px;
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
            line-height: 1;
        }
        
        .kpi-label {
            color: #6c757d;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .kpi-change {
            font-size: 0.875rem;
            margin-top: 10px;
        }
        
        .bg-success-light {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .bg-warning-light {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }
        
        .bg-danger-light {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        .bg-info-light {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-top: 30px;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s;
        }
        
        .activity-item:hover {
            background: #f8f9fa;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .badge-plan {
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 0;
            margin-bottom: 40px;
            border-radius: 0 0 24px 24px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="mb-2">
                        <i class="fas fa-chart-line me-3"></i>
                        Dashboard Executivo
                    </h1>
                    <p class="mb-0 opacity-75">Visão 360º do seu negócio SaaS</p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="text-white-50 mb-1">Última atualização</div>
                    <div class="fw-bold fs-5" id="lastUpdate"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        <!-- KPIs Row -->
        <div class="row g-4 mb-4">
            <!-- MRR -->
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-icon bg-success-light">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="kpi-label">MRR (Receita Mensal)</div>
                    <div class="kpi-value text-success" id="mrr">R$ 0</div>
                    <div class="kpi-change text-success">
                        <i class="fas fa-arrow-up"></i> 12.5% vs mês anterior
                    </div>
                </div>
            </div>

            <!-- Churn Risk -->
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-icon bg-warning-light">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="kpi-label">Risco de Churn</div>
                    <div class="kpi-value text-warning" id="churnRisk">0</div>
                    <div class="kpi-change text-muted">
                        usuários inadimplentes
                    </div>
                </div>
            </div>

            <!-- Saúde Operacional -->
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-icon bg-danger-light">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="kpi-label">Saúde Operacional</div>
                    <div class="kpi-value text-danger" id="healthScore">0%</div>
                    <div class="kpi-change text-muted">
                        sites offline agora
                    </div>
                </div>
            </div>

            <!-- Fila Celery -->
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-icon bg-info-light">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="kpi-label">Fila de Tarefas</div>
                    <div class="kpi-value text-info" id="queueSize">0</div>
                    <div class="kpi-change text-muted">
                        tarefas pendentes
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos Row -->
        <div class="row g-4">
            <!-- Distribuição de Planos -->
            <div class="col-md-6">
                <div class="chart-container">
                    <h5 class="mb-4">
                        <i class="fas fa-chart-pie text-primary me-2"></i>
                        Distribuição de Planos
                    </h5>
                    <canvas id="planChart" height="250"></canvas>
                </div>
            </div>

            <!-- Sites por Status -->
            <div class="col-md-6">
                <div class="chart-container">
                    <h5 class="mb-4">
                        <i class="fas fa-chart-bar text-success me-2"></i>
                        Sites por Status
                    </h5>
                    <canvas id="statusChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Atividade Recente -->
        <div class="chart-container mt-4">
            <h5 class="mb-4">
                <i class="fas fa-history text-info me-2"></i>
                Atividade Recente
            </h5>
            
            <div id="recentActivity">
                <!-- Será preenchido via JavaScript -->
                <div class="activity-item">
                    <div class="activity-icon bg-success-light">
                        <i class="fas fa-user-plus text-white"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">Novo cadastro</div>
                        <div class="text-muted small">usuario@empresa.com - Plano Pro</div>
                    </div>
                    <div class="text-muted small">há 5 minutos</div>
                </div>
                
                <div class="activity-item">
                    <div class="activity-icon bg-success-light">
                        <i class="fas fa-check text-white"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">Pagamento recebido</div>
                        <div class="text-muted small">R$ 149,00 - empresa.com</div>
                    </div>
                    <div class="text-muted small">há 12 minutos</div>
                </div>
                
                <div class="activity-item">
                    <div class="activity-icon bg-warning-light">
                        <i class="fas fa-exclamation text-white"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">Site offline detectado</div>
                        <div class="text-muted small">exemplo.com.br - timeout após 30s</div>
                    </div>
                    <div class="text-muted small">há 18 minutos</div>
                </div>
                
                <div class="activity-item">
                    <div class="activity-icon bg-info-light">
                        <i class="fas fa-bell text-white"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">Alerta de SSL</div>
                        <div class="text-muted small">meusitewordpress.com - expira em 7 dias</div>
                    </div>
                    <div class="text-muted small">há 25 minutos</div>
                </div>
            </div>
        </div>

        <!-- Quick Stats Table -->
        <div class="chart-container mt-4">
            <h5 class="mb-4">
                <i class="fas fa-table text-warning me-2"></i>
                Estatísticas Rápidas
            </h5>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Métrica</th>
                            <th>Valor Atual</th>
                            <th>Meta</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><i class="fas fa-users text-primary me-2"></i>Total de Usuários</td>
                            <td class="fw-bold" id="totalUsers">0</td>
                            <td>1000</td>
                            <td><span class="badge bg-success">No caminho</span></td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-globe text-success me-2"></i>Sites Monitorados</td>
                            <td class="fw-bold" id="totalSites">0</td>
                            <td>5000</td>
                            <td><span class="badge bg-warning">Acelerando</span></td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-percentage text-info me-2"></i>Taxa de Conversão</td>
                            <td class="fw-bold">23.5%</td>
                            <td>30%</td>
                            <td><span class="badge bg-info">Crescendo</span></td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-chart-line text-warning me-2"></i>ARPU (Ticket Médio)</td>
                            <td class="fw-bold" id="arpu">R$ 0</td>
                            <td>R$ 89</td>
                            <td><span class="badge bg-success">Atingido</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Atualiza horário
        function updateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleString('pt-BR');
        }
        updateTime();
        setInterval(updateTime, 1000);
        
        // Busca dados da API
        async function loadDashboardData() {
            try {
                const response = await fetch('/admin/api/dashboard-stats');
                const data = await response.json();
                
                // Atualiza KPIs
                document.getElementById('mrr').textContent = `R$ ${data.mrr.toLocaleString('pt-BR')}`;
                document.getElementById('churnRisk').textContent = data.churn_risk;
                document.getElementById('healthScore').textContent = `${data.health_score}%`;
                document.getElementById('queueSize').textContent = data.queue_size;
                document.getElementById('totalUsers').textContent = data.total_users;
                document.getElementById('totalSites').textContent = data.total_sites;
                document.getElementById('arpu').textContent = `R$ ${data.arpu.toFixed(2)}`;
                
                // Gráfico de Planos
                const planCtx = document.getElementById('planChart').getContext('2d');
                new Chart(planCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Free', 'Pro', 'Agency'],
                        datasets: [{
                            data: [data.plan_free, data.plan_pro, data.plan_agency],
                            backgroundColor: ['#6c757d', '#ffc107', '#28a745']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                // Gráfico de Status
                const statusCtx = document.getElementById('statusChart').getContext('2d');
                new Chart(statusCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Online', 'Offline', 'Desconhecido'],
                        datasets: [{
                            label: 'Sites',
                            data: [data.sites_online, data.sites_offline, data.sites_unknown],
                            backgroundColor: ['#28a745', '#dc3545', '#6c757d']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }
        
        // Carrega dados ao iniciar
        loadDashboardData();
        
        // Atualiza a cada 30 segundos
        setInterval(loadDashboardData, 30000);
    </script>
</body>
</html>
